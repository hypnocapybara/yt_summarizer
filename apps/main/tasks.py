import io
import whisper

from pytube import Channel, YouTube
from pytube.streams import Stream

from transformers import AutoModelForCausalLM, AutoTokenizer, BitsAndBytesConfig, pipeline

from apps.main.models import YoutubeChannel, YoutubeVideo


def parse_channel(channel: YoutubeChannel):
    yt_channel = Channel(channel.url)

    channel.title = yt_channel.title
    channel.save()

    videos = []


def parse_video(video: YoutubeVideo):
    yt_video = YouTube(video.url)

    video.youtube_id = yt_video.video_id
    video.title = yt_video.title
    video.save()

    audio_streams = [stream for stream in yt_video.streams if stream.type == 'audio']
    audio_streams = sorted(audio_streams, key=lambda s: s.bitrate, reverse=True)
    if not audio_streams:
        return

    stream: Stream = audio_streams[0]
    buffer = io.BytesIO()
    stream.stream_to_buffer(buffer)
    video.audio_file.save(video.youtube_id, buffer)
    video.save()


def transcribe_video(video: YoutubeVideo):
    model = whisper.load_model('medium')
    result = model.transcribe(video.audio_file.path)

    video.transcription_language = result['language']
    video.transcription = result['text']
    video.save()


TEMPLATE = """
Ты - умный суммаризатор транскрипций YouTube видео. Ты выделяешь ключевые моменты из кусков транскрипций.
Следующий текст в тройных кавчках - это часть транскрипта
```
{text}
```
Основываясь на нем, выдели основные ключевые моменты
"""

def summarize_video(video: YoutubeVideo):
    if not video.transcription or not video.transcription_language:
        return

    bnb_config = BitsAndBytesConfig(
        load_in_4bit=True,
        bnb_4bit_quant_type='nf4',
        bnb_4bit_use_double_quant=True,
    )

    model = AutoModelForCausalLM.from_pretrained(
        'mistralai/Mistral-7B-Instruct-v0.2',
        quantization_config=bnb_config
    )

    text = 'Неужели пресловутое китайское экономическое чудо наконец заканчивается? Подходит к концу 2023 год и примерно год назад власти Китайской компартии отменили пресловутые жесткие ковидные ограничения. Тогда было очень много разговоров, что сейчас китайская экономика рванет и покажет Америке и всему западу класс, будут бурные темпы роста, Китай выйдет в мировые лидеры. Но прошел год и мы видим, что он стал годом разочарования. Показатели китайской экономики плохие, экспорт падает, потребительская активность идет на спад, идут на спад цены на жилье, огромные долги накопленные в государственном и частном секторе. Это Владимир Милов и мы сегодня с вами вернемся на нашем канале к теме Китая. Китай это страна, на которую путинская Россия сделала ставку как на главного международного партнера. Сегодня вот все российские экономические цепочки выстроены прежде всего с ориентации на Китай. Мы импортируем оттуда товары, для промышленности, потребительского рынка поставляем туда сырье и на самом деле китайская экономика намного больше нашей. Когда она чихает, то у России есть шансы не просто простудиться, но и при неблагоприятном исходе угодить прямо сразу в морг. И таким образом от экономического здоровья Китая для России очень многое зависит, потому что путин сделал ставку именно на китайскую экономику. Вот давайте взглянем подробно на то, что там происходит, какие там есть серьезные проблемы и насколько они носят фундаментальный характер и что от этого всего ожидать россиянам. Итак, вот собственно весь уходящий 2023 год прошел под знаменем постоянных очень плохих новостей, которые приходят из Китая. Падает экспорт, падают рекордными темпами цены на жилье, охлаждается потребительский спрос, огромные пузыри на рынках недвижимости, рекордная молодежная безработица, огромный накопленный долг, с которым непонятно что делать, это одна из серьезных проблем, у которых стоит сейчас поговорить отдельно, и инвестиции бегут. Инвесторы похоже окончательно потеряли веру в Китай и в его экономическое будущее. Страна, которая построила 40 лет бурного экономического роста на притоке иностранных инвестиций, теперь сталкивается с максимальным за все время уходом инвесторов, которые уже похоже не развернуть. Вот я собственно для начала хотел вам рассказать несколько фактов и объяснить, вот откуда вдруг у Китая такие экономические проблемы. На самом деле, если вспомнить вот то, что происходило в последние три-четыре десятилетия, то вы могли слышать очень многих людей, которые Китай ставили вот пример такой противоположной модели, чем путь, по которому пошла Россия. Типа видите, они вот там не распускали коммунистическое правительство, а под надзором компартии провели рыночные реформы, но все это контролировалось, везде было вот это все видящее окно коммунистического государства. Очень многие люди говорили о том, что вот это как раз была правильная модель, видите как бурно Китай рос в последние несколько десятилетий, а у России были всякие проблемы, был экономический спад, были трудности 90-х и много чего еще. Если вот вы вспомните всю эту дискуссию, то Китай нам часто приводили как раз как позитивный пример. Вот некий магистральный путь, по которому нужно было идти. Кстати говоря, именно вот эту риторику на вооружение в свое время взял Владимир Путин, где-то в середине нулевых годов он совершил разворот экономического курса и сказал, нам не нужен никакой рынок, никакие реформы, никакая приватизация, а мы вот пойдем по пути строительства экономического будущего на плечах вот этих атлантов в виде крупных госкорпораций, примерно как это делает китайская компартия. И вот все эти разговоры, вся эта риторика сегодня сталкивается с полным крахом, и китайская экономическая модель очевидно уперлась в бетонную стену. Все показатели, вот как их не пытались реанимировать в течение последнего года, несмотря на отмену ковидных ограничений, они так и идут вниз. Ничего не взлетело. Китайская экономика не заработала. Очень интересно поговорить о том, почему так происходит, и несколько причин для этого. Ну первая история довольно очевидная и естественная, о ней в принципе говорили много лет. Китай уперся в некий естественный потолок роста, они-то в общем-то так бурно росли в 80-е, 90-е нулевые годы, прежде всего за счет того, что импортировали в коммунистическую экономику самые примитивные институты довольно дикого рыночного капитализма. Просто на месте плановых отношений устроили рыночные, и экономика пошла бурно расти. Вообще говоря, у нас было нечто похожее в конце 90-х начале нулевых годов, когда темпы роста ВВП превышали 7% в год, и мы вам об этом рассказывали в нашем цикле про 2000-е, бурный рост первых путинских лет, когда рыночная экономика наконец-то заработала. Но, как и тогда у России, возникал вопрос, а что дальше? Окей, вы перешли от планово-административного хозяйства к рынку, но в рынке тоже это непростое дело выстроить конкуренцепособную, ориентированную в будущую модель. Это, как правило, не получается сделать на плечах госкорпораций, которые контролируются государством, они неэффективны, громоздки, там большая коррупция и так далее. Здесь нужно очень аккуратно и нежно обращаться с инвесторами, чтобы они не бежали из страны, как это мы видим на примере России, а приходили, инвестировали, создавали новое производство. Для этого, для инвесторов надо создавать хороший предпринимательский климат, не дрючить их избыточным регулированием, инвесторы не должны сталкиваться с опасностью каких-то политических рисков и осложнений, и политическая атмосфера для бизнеса должна быть нейтральной, без всяких там агрессий, нападений, конфронтации и прочего. Ну и в целом мы видим, что эта китайская модель была основана во многом на использование дешевой рабочей силы, на предприятие приезжали огромное количество мигрантов из совершенно нищей сельской местности, которые получали за свой труд копейки, и вот так Китай превратился в ключевую, как говорят, мировую производственную фабрику. Но, впоследствии, вместе с экономическим ростом зарплаты тоже начали подтягиваться, и вдруг выяснилось, что если вы хотите делать ставку на использование сверхдешевого труда, то вы уже проигрываете. Рост дал свои плоды, доходы населения и зарплаты выросли, и теперь бизнесу, который хочет прям строить производство в странах с супер дешевой рабочей силой, ему интереснее идти в Вьетнам, Бангладеш, Филиппины, Индонезию и никакой Китай с подорожавшими зарплатами ему уже не нужен. Вот, собственно, материалы о начале масштабного процессорелокации производств из Китая, в том числе в соседние азиатские страны, ну и во многие они появились еще в нулевые годы. Это означало, что китайской компартии нужно было переходить к следующему этапу реформ. Вместо примитивной гос-капиталистической экономики, контролируемой пристальным оком ЦК КПСС, переходить к нормальным политическим реформам, к развитой рыночной экономике западного образца, которая подпирается открытыми демократическими политическими институтами, где нет вот этого навеса коррумпированных госкорпораций и постоянного контроля со стороны компартии, где нет дополнительных рисков для инвесторов, которые создаются государством. Собственно говоря, лет 20 назад в мире думали, что Китай по этому пути и пойдет, потому что ловушка была довольно очевидна. Деваться некуда, хотите перейти к следующей фазе роста, придется превращаться в нормальную демократию западного образца. Но, как мы знаем, надежда на это похоронила нынешнее поколение лидеров китайской компартии во главе с Сидзинпином, которое вместо политической демократизации пошло как раз по пути разворота на 180 градусов в сторону консолидации власти, отмены сроков для верховного правителя, вот там были предельные сроки пребывания в власти, вот превращение в такой полноценный авторитарный режим с агрессивным душком, что мы видим, например, и по действиям в отношении островов Спраттли в Южно-Китайском море, мы сейчас об этом поговорим, и в поглощении Гонконга, и в угрозах Тайваню, и в целом, вот в поддержке агрессивных диктаторских режимов во всем мире, что привело к существенной степени конфронтации с Западом. Таким образом, китайское государство, китайская компартия не захотели из экономики окончательно уходить и передавать ее во власть полноценно действующих демократических институтов, независимой судебной системы, работающих законов и так далее. Они решили, наоборот, консолидировать власть так вот по-сталински, как это было в раннем Советском Союзе после окончания НЭПа, периода экономической либерализации двадцатых годов. И вот здесь вдруг выяснилось, что какой-то новой модели роста, которая могла бы привести Китаю к успеху в новых условиях, у них, у Сидзинпина и у китайской компартии в рукаве нет. Здесь возникла вторая история, которая на самом деле очень и очень типична для авторитарных режимов, которые могут на начальной стадии достигать каких-то видимых экономических успехов, но потом выясняется, что авторитаризм создает какие-то свои серьезные дополнительные проблемы и ограничения, которые мешают двигаться вперед. Например, одна из очень распространенных историй это когда было много денег, были большие возможности, приток капитала, бурный рост экономики, наинвестировали черт знает во что. Развитые рыночные демократии западного типа предполагают такой естественный выход из этой ситуации, когда образуются пузыри, они лопаются, да, возникает определенный кризис, но рыночная экономика в совокупности с демократическими политическими институтами нащупывает из этого выход. Как вот было, например, во время того же ипотечного кризиса в Соединенных Штатах в 2007-2008 годах или во время последующего кризиса еврозоны. Там помните была история с Грецией, которая фактически обанкротилась, ее спасали, вот все говорили о скором развале зоны евро, но мы видим, что рыночные демократии вот к таким кризисам адаптируются и за счет гибкости, за счет того, что нет вот этой давлеющей руки государства, они и так или иначе из этих кризисов политическим консенсусом, эффективной работой рынков выходят. В Китае получилась другая ситуация, там все равно на протяжении вот работы этой модели государственного капитализма, роль государственных институтов была очень сильной. И вот в частности две из основных проблем, которые сегодня Китай тянут вниз, они прямо порождены вот собственно этой неэффективной и непрозрачной государственно-олигархической моделью. Первое, это огромный объем долга, который в Китае накопился, прежде всего здесь существенную роль играет долг региональных местных властей. Это вроде как не центральное правительство, поэтому на балансах центрального правительства Китая вот все эти накопленные госдолги более низкого уровня не отражаются. Но тем не менее это те же чиновники, часть китайской коммунистической вертикали, которые когда было много денег, назанимали и натратили их в общем непонятно на что, теперь вот этот долг на Китае висит с огромной нагрузкой. Кстати, вот когда вы слышите вот эти все разговоры, а вы видели какой госдолг у США, это один из очень популярных рефренов российской пропаганды, то здесь очень важно понимать, что при том, что долг у центрального правительства Китая относительно низкий, но если к этому прибавить долги региональных властей, частного сектора и домохозяйств, то это получается около 300% ВВП. Это гораздо выше, чем в любых Соединенных Штатах. Вот собственно издание Forbes дает оценку, хотя точно оценить сложно, но тем не менее совокупный долг всех участников китайской экономики, включая разные уровни государства, составляет около 300% ВВП, ну а например в Соединенных Штатах или в среднем в развитых странах Запада это где-то там типа 250 с чем-то процентов, то есть как мы видим у Китая долги существенно выше. Понятно, что эти долги будет гораздо сложнее отдавать в ситуации, когда экономика замедлилась. Но очень хорошо знаем, как это происходит по российской модели, кстати недавно делали отдельное видео на нашем канале про закредитованность россиян, люди набирают много кредитов в расчете на рост доходов, на улучшение экономической ситуации. Когда этого улучшения и роста не происходит, все это оборачивается неким пузырем. Долги надо с чего-то отдавать, а отдавать не с чего, роста больше нет. Вот это очень похоже на ту ситуацию, которая имеет место сегодня в Китае. Ну и следующая история, которую я думаю вы где-то может быть краем уха слышали или даже подробно о ней знаете, это глубокий кризис на рынке китайской недвижимости. То есть опять вот под мудрым руководством коммунистической партии все слушали, верили, думали, что Китай ждет еще вторые 40 лет бурного экономического роста, ну и настроили там офисных и жилых площадей в расчете на то, что все дальше будет такими же темпами расти и вот эту недвижимость можно будет продать, сдать в аренду и получать на этом доходы. На самом деле, многие из вас возможно и были в Китае, видели это дело своими глазами, но сейчас вот интернет заполнен всевозможными роликами, где показывают огромное количество вот этого настроенного, но пустующего офисного и жилого фонда. Иногда вот буквально можно увидеть целые такие даже микрорайоны и города приведения. То есть это недвижимость, которая была построена в расчете на дальнейший бурный экономический рост и спрос на все эти площади, но роста нет и спроса, соответственно, тоже нет. Все это стоит пустует. И вы наверняка вот слышали в этом году новости про банкротство крупнейших китайских девелоперов, таких как, например, Evergrande или Country Garden, и там есть ряд других, по поводу которых рынок очень сильно беспокоится. Вот это еще одна история, если бы в Китае была нормальная рыночная система и было такой пузырь на рынке недвижимости, то рынок запустил бы механизм автокоррекции. В этой ситуации, мы знаем, такие кризисы возникали в том числе и в развитых странах. Но вот в Китае ситуация совершенно другая. Здесь, в принципе, развитие экономики происходит так или иначе в смычке чиновников и крупных корпораций, которые с ними связаны. И вот как раз, например, девелоперы, которые настроили всю недвижимость в расчете на быстрый рост, очень многие из них как раз тоже являются источниками всей этой огромной массы госдолга, которая сегодня у Китая сложилась. Если бы Китай все-таки пошел по пути превращения в реальную современную развитую рыночную демократию, ну такую, например, как Южная Корея или Тайвань. Обратите внимание, там же реформы проходили примерно в одно и то же время. Но где-то вот в 90-е годы Южная Корея и Тайвань стали демократическими странами, и там вот этот рыночный механизм автокоррекции действует. Подобных кризисов там нет. Зато мы, например, знаем, что в Южной Корее независимые, в том числе судебные власти, очень серьезно преследуют чиновников, которые работали в интересах крупных олигархических корпораций. Например, вот бывший президент Южной Кореи за это дело получил тюремный срок. В Китае таких механизмов рыночной демократической автокоррекции нету, поэтому вот пузыри там приобрели какой-то совершенно невероятный масштаб. Вся эта ситуация, кстати, очень сильно связывает китайскому правительству руки для того, чтобы запустить мощные программы стимулирования и поддержки экономики. Вы, наверное, помните, как в последнее время, прежде всего, когда был кризис, связанный с ковидом, то западное правительство вливали в экономику в буквальном смысле триллионы долларов и евро, для того чтобы в кризисных условиях ее поддержать. Почему китайские власти не могут так сделать? А вот ровно потому, что над ними уже висит такой огромный долговой навес, который больше, чем в США и больше, чем в Западной Европе. Вот это важно понимать, и российская пропаганда вам об этом не расскажет. И китайские власти очень боятся, что любые программы стимулирования экономики приведут к выходу долга на закритический уровень. Сегодня, по крайней мере, при наличии долгового китайского пузыря, центральное правительство остается, как говорили о стравком стабильности, номинально вот госдолг центрального правительства Китая не очень высокий. Но если они сделают то, что сделали западные страны, откуда они брали деньги на программы стимулирования экономики, занимали их на рынке через государственные займы, облигации и прочее. Китайское правительство боится, что если оно сейчас пойдет на программы масштабного стимулирования, то оно полностью уничтожит эту ситуацию, когда по крайней мере у центральных властей долг относительно низкий, и долг просто выйдет на запредельные, закритические уровни, и, собственно, вот весь Китай погрязнет в долговой яме. Поэтому мы очень интересны, мы слышали в течение всего этого года какие-то сигналы и обещания от Сидзинпина, что вот мы запустим какие-то программы стимулирования экономики, но ничего они не запускают, потому что и так в предыдущий период набрали настолько огромный долг, что дальше двигаться совсем этим некуда.'
    tokenizer = AutoTokenizer.from_pretrained("mistralai/Mistral-7B-Instruct-v0.2")
    messages = [
        {"role": "user", "content": TEMPLATE.format(text=text)},
    ]

    encodeds = tokenizer.apply_chat_template(messages, return_tensors="pt")

    model_inputs = encodeds.to('cpu')

    generated_ids = model.generate(model_inputs, max_new_tokens=1000, do_sample=True)
    decoded = tokenizer.batch_decode(generated_ids)
    print(decoded[0])
